<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Relief Fund</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <nav>
        <div class="nav-inner">
            <span>ðŸŒ™ Ramadan Relief</span>
        </div>
    </nav>

    <div class="container">
        <main>
            <img src="/images/banner.png" class="hero-img" alt="Campaign Banner" onerror="this.src='https://images.unsplash.com/photo-1593113616825-d66722e28ee9?w=800&q=80'">

            <div class="mobile-stats-embed" style="display:none;">
                <span class="big-amt live-amt">â‚¦<%= raised.toLocaleString() %></span>
                <span class="goal-lbl">raised of â‚¦<%= goal.toLocaleString() %> goal</span>
                <div class="bar-bg" style="margin-top: 10px;">
                    <div class="bar-fill live-bar" style="width: <%= (raised / goal) * 100 %>%"></div>
                </div>
            </div>
            <script>if(window.innerWidth <= 768) document.querySelector('.mobile-stats-embed').style.display = 'block';</script>

            <div class="title-section">
                <h1>Ramadan Food Relief: Feed 50 Families</h1>
                <div class="organizer">
                    <span>Organizer: <strong>Abu Hayyan School</strong></span>
                    <span class="verified-badge">Verified</span>
                </div>
            </div>

            <div class="content-box">
                <p><strong>Goal: â‚¦1,000,000 to provide food packs for 50 vulnerable families before Ramadan begins.</strong></p>
                
                <p>Rising food costs have left many in our community struggling. We are collecting funds to distribute essential Food Packs consisting of:</p>
                <ul>
                    <li>Rice & Beans</li>
                    <li>Garri & Oil</li>
                    <li>Dates & Milk</li>
                </ul>
                <p><em>"Whoever provides food for a fasting person... has the same reward."</em> (Tirmidhi)</p>
                <p><strong>100% Transparent:</strong> Every donation appears live on this page.</p>
            </div>

            <div class="feed-section">
                <div class="feed-header">
                    <span>Recent Donations</span>
                    <span style="font-size:0.9rem; color:#6b7280"><span id="count"><%= donations.length %></span> total</span>
                </div>
                <div id="feed">
                    <% donations.forEach(function(d) { %>
                        <div class="donation-item">
                            <div class="avatar">âœ“</div>
                            <div class="d-info">
                                <strong><%= d.donorName %></strong>
                                <span>Donated â‚¦<%= d.amount.toLocaleString() %></span>
                                <% if(d.comment) { %><div class="d-msg"><%= d.comment %></div><% } %>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="card">
                <div class="stats-row">
                    <span class="big-amt live-amt">â‚¦<%= raised.toLocaleString() %></span>
                    <span class="goal-lbl">raised of â‚¦<%= goal.toLocaleString() %> goal</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill live-bar" style="width: <%= (raised / goal) * 100 %>%"></div>
                </div>
                
                <button onclick="openModal()" class="btn-primary">Donate Now</button>
                
                <div class="secure-badge">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
                    Secured by Paystack
                </div>
            </div>
        </aside>
    </div>

    <div class="mobile-nav">
        <div class="mob-stats live-amt">â‚¦<%= raised.toLocaleString() %></div>
        <button onclick="openModal()" class="mob-btn">Donate</button>
    </div>

    <div id="modal" class="modal-wrap">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                <h3>Donate Amount</h3>
                <span onclick="closeModal()" style="cursor:pointer">&times;</span>
            </div>
            <input type="number" id="amt" class="inp" placeholder="Amount (e.g. 2000)" required>
            <input type="email" id="email" class="inp" placeholder="Email Address" required>
            <input type="text" id="name" class="inp" placeholder="Name (Optional)">
            <input type="text" id="comment" class="inp" placeholder="Comment (Optional)">
            <button onclick="pay()" class="btn-primary">Proceed to Paystack</button>
        </div>
    </div>

    <script>
        const publicKey = "<%= publicKey %>";
        const socket = io();

        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        socket.on('new_donation', (data) => {
            document.querySelectorAll('.live-amt').forEach(el => el.innerText = "â‚¦" + data.totalRaised.toLocaleString());
            document.querySelectorAll('.live-bar').forEach(el => el.style.width = ((data.totalRaised / <%= goal %>) * 100) + "%");
            
            const feed = document.getElementById('feed');
            const html = `
                <div class="donation-item" style="background:#ecfdf5; padding:8px; border-radius:4px;">
                    <div class="avatar">âœ“</div>
                    <div class="d-info">
                        <strong>${data.donorName}</strong>
                        <span>Donated â‚¦${data.amount.toLocaleString()}</span>
                        ${data.comment ? `<div class="d-msg">${data.comment}</div>` : ''}
                    </div>
                </div>`;
            feed.insertAdjacentHTML('afterbegin', html);
        });

        async function pay() {
            const amount = document.getElementById('amt').value;
            const email = document.getElementById('email').value;
            if(!amount || !email) return alert("Amount and Email required");

            const res = await fetch('/donate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ amount, email, name: document.getElementById('name').value, comment: document.getElementById('comment').value })
            });
            const data = await res.json();

            const handler = PaystackPop.setup({
                key: publicKey,
                email: email,
                amount: amount * 100,
                ref: data.reference,
                callback: function() { closeModal(); alert("Donation Successful!"); }
            });
            handler.openIframe();
        }
    </script>
</body>
</html>
