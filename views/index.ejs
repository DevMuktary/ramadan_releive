<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Relief Fund</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <header>
        <div class="container">
            <div class="brand">üåô Ramadan Relief 1447AH</div>
        </div>
    </header>

    <div class="container">
        <h1 class="campaign-title">Ramadan Food Relief for 50 Families</h1>
        
        <div class="gfm-grid">
            <div class="main-content">
                <div class="hero-image">
                    <img src="/images/banner.jpg" alt="Ramadan Relief Banner" onerror="this.style.backgroundColor='#064e3b'">
                </div>

                <div class="organizer">
                    <div class="organizer-icon">AH</div>
                    <div>
                        <strong>Donation handled by</strong><br>
                        ABU HAYYAN SCHOOL OF SKILLS AND DEEN
                    </div>
                </div>

                <div class="story-text">
                    <p><strong>As-salamu alaykum wa rahmatullahi wa barakatuh,</strong></p>
                    <br>
                    <p>As the blessed month of Ramadan approaches, many families in our community are wondering where their Suhoor and Iftar will come from. While we prepare our pantries, our neighbors are struggling with the rising cost of food.</p>
                    <br>
                    <p>Our goal is to raise <strong>‚Ç¶1,000,000</strong> to provide essential food packs (Rice, Beans, Garri, Oil, and Dates) to 50 vulnerable households before the moon is sighted.</p>
                    <br>
                    <p>The Prophet (Ô∑∫) said: <em>"Whoever provides food for a fasting person to break his fast with, then for him is the same reward as his..."</em> (Tirmidhi).</p>
                    <br>
                    <p><strong>100% Transparency:</strong> Every Naira donated is tracked live on this page. May Allah accept your Sadaqah.</p>
                </div>

                <div class="updates-section">
                    <h3>Donation Feed</h3>
                    <div id="donationFeed" class="donation-list">
                        <% donations.forEach(function(d) { %>
                            <div class="donation-item">
                                <div class="donor-avatar">‚ù§</div>
                                <div class="donor-info">
                                    <div class="donor-name"><%= d.donorName %></div>
                                    <div class="donor-amount">‚Ç¶<%= d.amount.toLocaleString() %></div>
                                    <% if(d.comment) { %>
                                        <div class="donor-comment"><%= d.comment %></div>
                                    <% } %>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>

            <aside class="sticky-sidebar">
                <div class="donation-card">
                    <div class="progress-header">
                        ‚Ç¶<span id="currentAmount"><%= raised.toLocaleString() %></span>
                        <span class="goal-text">raised of ‚Ç¶<%= goal.toLocaleString() %> goal</span>
                    </div>

                    <div class="progress-container">
                        <div id="progressBar" class="progress-fill" style="width: <%= (raised / goal) * 100 %>%"></div>
                    </div>

                    <div style="margin-bottom: 20px; font-weight: bold;">
                        <span id="donorCount"><%= donations.length %></span> donations
                    </div>

                    <button onclick="openModal()" class="btn-donate">Donate now</button>
                    <button class="btn-share">Share</button>
                    
                    <div style="margin-top: 15px; font-size: 0.8rem; text-align: center; color: #666;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" height="20" style="vertical-align: middle; margin: 0 5px;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/MasterCard_Logo.svg" height="20" style="vertical-align: middle; margin: 0 5px;">
                        Secured by Paystack
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">Make a Contribution</h2>
            
            <div class="preset-amounts">
                <button class="preset-btn" onclick="setAmount(1000)">‚Ç¶1,000</button>
                <button class="preset-btn" onclick="setAmount(5000)">‚Ç¶5,000</button>
                <button class="preset-btn" onclick="setAmount(10000)">‚Ç¶10,000</button>
            </div>

            <div class="input-group">
                <input type="number" id="amount" placeholder="Enter amount (‚Ç¶)">
            </div>
            <div class="input-group">
                <input type="text" id="name" placeholder="Full Name (Optional)">
            </div>
            <div class="input-group">
                <input type="email" id="email" placeholder="Email Address (Required)">
            </div>
            <div class="input-group">
                <textarea id="comment" placeholder="Leave a word of support..." rows="3"></textarea>
            </div>

            <button class="btn-donate" style="background: #02a95c; color: white;" onclick="payNow()">Continue</button>
        </div>
    </div>

    <script>
        const publicKey = "<%= publicKey %>";
        const socket = io();

        // 1. LIVE UPDATES
        socket.on('new_donation', (data) => {
            // Update Text
            document.getElementById('currentAmount').innerText = data.totalRaised.toLocaleString();
            
            // Update Bar
            const percentage = Math.min((data.totalRaised / <%= goal %>) * 100, 100);
            document.getElementById('progressBar').style.width = percentage + "%";

            // Add to feed
            const feed = document.getElementById('donationFeed');
            const newItem = `
                <div class="donation-item" style="background-color: #f0fdf4;">
                    <div class="donor-avatar">‚ù§</div>
                    <div class="donor-info">
                        <div class="donor-name">${data.donorName}</div>
                        <div class="donor-amount">‚Ç¶${data.amount.toLocaleString()}</div>
                        ${data.comment ? `<div class="donor-comment">${data.comment}</div>` : ''}
                    </div>
                </div>
            `;
            feed.insertAdjacentHTML('afterbegin', newItem);
        });

        // 2. MODAL LOGIC
        function openModal() { document.getElementById('paymentModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('paymentModal').style.display = 'none'; }
        function setAmount(val) { document.getElementById('amount').value = val; }

        // 3. PAYMENT LOGIC
        async function payNow() {
            const email = document.getElementById('email').value;
            const amount = document.getElementById('amount').value;
            const name = document.getElementById('name').value;
            const comment = document.getElementById('comment').value;

            if(!email || !amount) { alert("Please enter email and amount"); return; }

            // Create Reference
            try {
                const res = await fetch('/donate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, amount, name, comment })
                });
                const data = await res.json();

                // Launch Paystack
                const handler = PaystackPop.setup({
                    key: publicKey,
                    email: email,
                    amount: amount * 100, // kobo
                    ref: data.reference,
                    onClose: () => { alert('Window closed.'); },
                    callback: (response) => {
                        closeModal();
                        // Optional: Redirect to a 'Thank You' page
                        alert('Alhamdulillah! Payment successful.');
                    }
                });
                handler.openIframe();

            } catch(e) {
                console.error(e);
                alert("Something went wrong. Please try again.");
            }
        }
    </script>
</body>
</html>
