<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Relief | Abu Hayyan School</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <nav>
        <div class="nav-inner">
            <span>üåô Ramadan Relief Fund</span>
        </div>
    </nav>

    <div class="container">
        <div class="hero-wrapper">
            <img src="/images/banner.png" class="hero-img" alt="Ramadan Relief" onerror="this.src='https://images.unsplash.com/photo-1593113616825-d66722e28ee9?w=800&q=80'">
        </div>

        <div class="content">
            <div class="stats-card">
                <div class="amt-row">
                    <span class="big-amt live-amt">‚Ç¶<%= raised.toLocaleString() %></span>
                    <span class="goal">of ‚Ç¶<%= goal.toLocaleString() %> target</span>
                </div>
                
                <div class="progress-bg">
                    <div class="progress-fill live-bar" style="width: <%= (raised / goal) * 100 %>%"></div>
                </div>

                <div class="share-grid">
                    <a href="https://wa.me/?text=I%20just%20supported%20the%20Ramadan%20Relief%20Fund.%20Please%20join%20us%20in%20feeding%20widows%20and%20orphans.%20Donate%20here:%20https://<%= host %>" target="_blank" class="btn-share btn-whatsapp">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592z"/></svg>
                        Share
                    </a>
                    <a href="https://wa.me/?text=Assalamu%20alaykum.%20I%20am%20personally%20supporting%20this%20Ramadan%20Relief%20Fund.%20Let's%20reach%20the%20target%20together.%20Click%20to%20donate:%20https://<%= host %>" target="_blank" class="btn-share btn-status">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.646 5.646L7 10.293 4.354 7.646a.5.5 0 1 1 .708-.708l2 2 4-4a.5.5 0 0 1 .708.708z"/></svg>
                        Add to Status
                    </a>
                </div>
            </div>

            <div class="campaign-story">
                <p><strong>Bismillah.</strong></p>
                <p>For those who knew me last Ramadan, you may remember that we raised a certain amount to support many people. AlhamdulillƒÅh, Allah used it as a means (sabab) to ease the affairs of some individuals.</p>
                <p>This year, Ramadan is approaching again, and I hope we can once more put smiles on a few faces; among them <strong>widows, orphans, debtors, and people who are genuinely struggling to survive.</strong></p>
                
                <blockquote>"Do we have a fixed target? Not exactly. However, a minimum of ‚Ç¶1,000,000 will go a long way."</blockquote>

                <p>This is my personal way of supporting the less privileged. I‚Äôm not interested in posting on Facebook, as it is already crowded with fundraisers. This appeal is shared primarily via my WhatsApp status.</p>

                <p>Also, to those who have messaged me in the past and present asking for help to raise funds, I sincerely ask for your forgiveness. I rarely do fundraising because I believe doing it too often reduces its value and I‚Äôm naturally a shy person.</p>
                
                <p><strong>No amount is too small.</strong> Whether it‚Äôs ‚Ç¶100, ‚Ç¶500, or ‚Ç¶1,000 daily before or during Ramadan, it counts and will make a difference.</p>
                
                <p>I will also reach out to some people offline and online, in shƒÅ‚Äô AllƒÅh. Can you do that too?</p>
                <p>So let us begin.</p>
            </div>

            <div class="feed-header">
                Recent Contributions (<span id="count"><%= donations.length %></span>)
            </div>
            <div id="donationFeed">
                <% donations.forEach(function(d) { %>
                    <div class="donation-item">
                        <div class="d-avatar"><%= d.donorName.charAt(0) %></div>
                        <div class="d-info">
                            <strong><%= d.donorName %></strong>
                            <span>Donated ‚Ç¶<%= d.amount.toLocaleString() %></span>
                            <% if(d.comment) { %> <div class="d-comment"><%= d.comment %></div> <% } %>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
    </div>

    <div class="sticky-footer">
        <div class="footer-inner">
            <div class="footer-info">
                Raised: <span class="live-amt" style="color:var(--primary-dark)">‚Ç¶<%= raised.toLocaleString() %></span>
            </div>
            <button onclick="openModal()" class="btn-donate-sticky">Donate Now</button>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <h3 style="font-weight:800; font-size:1.2rem;">Support the Cause</h3>
                <span onclick="closeModal()" style="font-size:24px; cursor:pointer; color:#999">&times;</span>
            </div>

            <div class="preset-grid">
                <div class="btn-preset" onclick="setPreset(1000, this)">‚Ç¶1,000</div>
                <div class="btn-preset" onclick="setPreset(2000, this)">‚Ç¶2,000</div>
                <div class="btn-preset" onclick="setPreset(5000, this)">‚Ç¶5,000</div>
                <div class="btn-preset" onclick="setPreset(10000, this)">‚Ç¶10,000</div>
            </div>

            <div class="inp-group">
                <input type="number" id="amt" class="inp" placeholder="Or enter custom amount (‚Ç¶)" required>
            </div>
            <div class="inp-group">
                <input type="email" id="email" class="inp" placeholder="Email Address" required>
            </div>
            <div class="inp-group">
                <input type="text" id="name" class="inp" placeholder="Name (Optional)">
            </div>
            <div class="inp-group">
                <input type="text" id="comment" class="inp" placeholder="Leave a prayer (Optional)">
            </div>

            <button onclick="pay()" class="btn-pay">Proceed to Paystack</button>
            <div style="text-align:center; font-size:0.8rem; color:#888; margin-top:10px;">Secured by Paystack</div>
        </div>
    </div>

    <script>
        const publicKey = "<%= publicKey %>";
        const socket = io();

        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        
        function setPreset(amount, btn) {
            document.getElementById('amt').value = amount;
            // Remove active class from all
            document.querySelectorAll('.btn-preset').forEach(b => b.classList.remove('active'));
            // Add to clicked
            btn.classList.add('active');
        }

        // Live Updates
        socket.on('new_donation', (data) => {
            document.querySelectorAll('.live-amt').forEach(el => el.innerText = "‚Ç¶" + data.totalRaised.toLocaleString());
            document.querySelectorAll('.live-bar').forEach(el => el.style.width = ((data.totalRaised / <%= goal %>) * 100) + "%");
            
            const count = document.getElementById('count');
            count.innerText = parseInt(count.innerText) + 1;

            const feed = document.getElementById('donationFeed');
            const item = `
                <div class="donation-item" style="background-color: #ecfdf5; padding-left:10px; padding-right:10px; border-radius:8px;">
                    <div class="d-avatar">‚úì</div>
                    <div class="d-info">
                        <strong>${data.donorName}</strong>
                        <span>Just donated ‚Ç¶${data.amount.toLocaleString()}</span>
                        ${data.comment ? `<div class="d-comment">${data.comment}</div>` : ''}
                    </div>
                </div>`;
            feed.insertAdjacentHTML('afterbegin', item);
        });

        async function pay() {
            const amount = document.getElementById('amt').value;
            const email = document.getElementById('email').value;
            const name = document.getElementById('name').value;
            const comment = document.getElementById('comment').value;

            if(!amount || !email) return alert("Please fill amount and email");

            try {
                const res = await fetch('/donate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ amount, email, name, comment })
                });
                const data = await res.json();

                const handler = PaystackPop.setup({
                    key: publicKey,
                    email: email,
                    amount: amount * 100,
                    ref: data.reference,
                    callback: function() {
                        closeModal();
                        alert("JazakAllahu Khairan! Donation verified.");
                    }
                });
                handler.openIframe();
            } catch(e) {
                alert("Error initializing payment");
            }
        }
    </script>
</body>
</html>
