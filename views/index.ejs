<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Relief Fund</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <nav>
        <div class="nav-content">
            <span>üåô Ramadan Relief</span>
        </div>
    </nav>

    <div class="container">
        
        <div class="main-column">
            <div class="hero-section">
                <img src="/images/banner.jpg" class="hero-img" alt="Ramadan Relief" onerror="this.src='https://images.unsplash.com/photo-1593113616825-d66722e28ee9?w=1000&q=80'">
            </div>

            <div class="mobile-progress-section" id="mobileProgress">
                <div class="progress-stats" style="margin-top: 20px;">
                    <div class="amount-big">‚Ç¶<span class="live-amount"><%= raised.toLocaleString() %></span></div>
                    <div class="goal-small">raised of ‚Ç¶<%= goal.toLocaleString() %> goal</div>
                </div>
                <div class="progress-track">
                    <div class="progress-fill live-bar" style="width: <%= (raised / goal) * 100 %>%"></div>
                </div>
            </div>

            <h1 class="campaign-title">Ramadan Food Relief for 50 Families</h1>
            
            <div class="organizer">
                <div class="org-avatar">AH</div>
                <div>
                    <strong>Abu Hayyan School</strong><br>
                    <span style="font-size: 0.9rem; color: #64748b;">Organizer &middot; Lagos, Nigeria</span>
                </div>
            </div>

            <div class="content-area">
                <div class="story-text">
                    <p><strong>As-salamu alaykum,</strong></p>
                    <p>As Ramadan approaches, many in our community face empty tables. Our goal is simple: Feed 50 families before the first Suhoor.</p>
                    <br>
                    <p>Your donation provides: Rice, Beans, Oil, and Dates. Every Naira is tracked live here.</p>
                </div>

                <div class="feed-header">Latest Donations (<span id="countTxt"><%= donations.length %></span>)</div>
                <div id="donationFeed">
                    <% donations.forEach(function(d) { %>
                        <div class="donation-item">
                            <div class="d-icon">‚ù§</div>
                            <div class="d-info">
                                <strong><%= d.donorName %></strong>
                                <span>‚Ç¶<%= d.amount.toLocaleString() %> &middot; <%= d.comment || 'Ramadan Mubarak' %></span>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="donation-card">
                <div class="progress-stats">
                    <div class="amount-big">‚Ç¶<span class="live-amount"><%= raised.toLocaleString() %></span></div>
                    <div class="goal-small">raised of ‚Ç¶<%= goal.toLocaleString() %> goal</div>
                </div>
                <div class="progress-track">
                    <div class="progress-fill live-bar" style="width: <%= (raised / goal) * 100 %>%"></div>
                </div>
                
                <button onclick="openModal()" class="btn-main">Donate Now</button>
                
                <div style="text-align: center; margin-top: 15px; font-size: 0.8rem; color: #64748b;">
                    üîí Secured by Paystack
                </div>
            </div>
        </div>

    </div>

    <div class="mobile-sticky-footer">
        <div class="mobile-stats">
            Raised: ‚Ç¶<span class="live-amount"><%= raised.toLocaleString() %></span>
        </div>
        <button onclick="openModal()" class="mobile-btn">Donate Now</button>
    </div>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 style="font-weight:800;">Donate</h2>
                <span onclick="closeModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            
            <div class="input-group">
                <input type="number" id="amt" placeholder="Amount (e.g. 5000)" required>
            </div>
            <div class="input-group">
                <input type="email" id="email" placeholder="Email Address" required>
            </div>
            <div class="input-group">
                <input type="text" id="name" placeholder="Name (Optional)">
            </div>
            <div class="input-group">
                <textarea id="comment" placeholder="Leave a prayer (Optional)"></textarea>
            </div>
            
            <button onclick="pay()" class="btn-main" style="background: var(--primary); color: white;">Proceed to Pay</button>
        </div>
    </div>

    <script>
        const publicKey = "<%= publicKey %>";
        const socket = io();

        function openModal() { document.getElementById('paymentModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('paymentModal').style.display = 'none'; }

        // LIVE UPDATES
        socket.on('new_donation', (data) => {
            // Update all amounts on page (Desktop sidebar + Mobile footer + Mobile in-content)
            document.querySelectorAll('.live-amount').forEach(el => {
                el.innerText = data.totalRaised.toLocaleString();
            });

            // Update all progress bars
            const percent = (data.totalRaised / <%= goal %>) * 100;
            document.querySelectorAll('.live-bar').forEach(el => {
                el.style.width = percent + "%";
            });

            // Add to feed
            const feed = document.getElementById('donationFeed');
            const item = `
                <div class="donation-item" style="background-color: #f0fdf4;">
                    <div class="d-icon">‚ú®</div>
                    <div class="d-info">
                        <strong>${data.donorName}</strong>
                        <span>‚Ç¶${data.amount.toLocaleString()} &middot; ${data.comment || 'Just now'}</span>
                    </div>
                </div>`;
            feed.insertAdjacentHTML('afterbegin', item);
        });

        async function pay() {
            const amount = document.getElementById('amt').value;
            const email = document.getElementById('email').value;
            const name = document.getElementById('name').value;
            const comment = document.getElementById('comment').value;

            if(!amount || !email) return alert("Amount and Email are required");

            const res = await fetch('/donate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ amount, email, name, comment })
            });
            const data = await res.json();

            const handler = PaystackPop.setup({
                key: publicKey,
                email: email,
                amount: amount * 100,
                ref: data.reference,
                callback: function() {
                    closeModal();
                    alert("Alhamdulillah! Donation successful.");
                }
            });
            handler.openIframe();
        }
    </script>
</body>
</html>
