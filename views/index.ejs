<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Relief 1447AH | Abu Hayyan School</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <nav>
        <div class="nav-inner">
            <span>üåô Ramadan Relief Fund</span>
        </div>
    </nav>

    <div class="container">
        
        <main>
            <div class="hero-image-container">
                <img src="/images/banner.jpg" alt="Ramadan Food Distribution" onerror="this.src='https://images.unsplash.com/photo-1593113616825-d66722e28ee9?w=1200&q=80'">
            </div>

            <div class="mobile-progress-wrapper" style="display:none;">
                 <div class="amount-large">‚Ç¶<span class="live-amt"><%= raised.toLocaleString() %></span></div>
                 <div class="goal-text">raised of ‚Ç¶<%= goal.toLocaleString() %> goal</div>
                 <div class="progress-container">
                    <div class="progress-bar live-bar" style="width: <%= (raised / goal) * 100 %>%"></div>
                 </div>
            </div>
            
            <script>
                // Simple script to toggle mobile progress display
                if(window.innerWidth <= 850) { document.querySelector('.mobile-progress-wrapper').style.display = 'block'; }
            </script>

            <h1 class="campaign-title">Ramadan Food Relief for 50 Vulnerable Families</h1>

            <div class="organizer-bar">
                <div class="org-icon">AH</div>
                <div class="org-info">
                    <div>Abu Hayyan School of Skills & Deen</div>
                    <div>Organizer &middot; Lagos, Nigeria</div>
                </div>
            </div>

            <div class="story-content">
                <p><strong>As-salamu alaykum wa rahmatullahi wa barakatuh,</strong></p>

                <p>Imagine the sun setting after a long day of fasting. You reach for a date and a glass of water, grateful for the meal ahead. Now, imagine a mother in our community watching the same sun set, but with a heavy heart, knowing she has nothing to place before her children for Iftar.</p>

                <p>This reality is becoming all too common. With the rising cost of food in Nigeria, many families who were once getting by are now struggling to afford even the basics. The joy of Ramadan‚Äîthe month of mercy‚Äîis being overshadowed by the anxiety of hunger.</p>

                <h3>Our Mission</h3>
                <p>This Ramadan, <strong>Abu Hayyan School of Skills and Deen</strong> has launched an urgent initiative to support 50 vulnerable families in our locality. We are not just raising money; we are raising hope.</p>

                <p>Our target is <strong>‚Ç¶1,000,000</strong>. This will allow us to purchase and distribute comprehensive Food Relief Packs before the first moon is sighted. Each pack is carefully curated to last a family for the majority of the month.</p>

                <h3>What Each Pack Contains:</h3>
                <ul>
                    <li>üçö <strong>Rice & Beans:</strong> The staple for strength.</li>
                    <li>ü•£ <strong>Garri:</strong> For Sahur and quick meals.</li>
                    <li>üçæ <strong>Vegetable Oil:</strong> Essential for cooking.</li>
                    <li>ü•õ <strong>Milk & Sugar:</strong> For pap and tea.</li>
                    <li>üå¥ <strong>Dates:</strong> To break the fast in accordance with the Sunnah.</li>
                </ul>
                <br>
                
                <h3>The Reward is Waiting</h3>
                <p>The Prophet Muhammad (Ô∑∫) said: <em>"Whoever provides food for a fasting person to break his fast with, then for him is the same reward as his (the fasting person), without anything being diminished from the reward of the fasting person."</em> (Tirmidhi)</p>

                <p>Every Naira you donate here is tracked live. Whether you give ‚Ç¶500 or ‚Ç¶50,000, your contribution will go directly into a pot intended to feed a believer.</p>

                <p><strong>Please donate whatever you can and share this link. May Allah accept your Sadaqah and multiply it in this world and the Hereafter.</strong></p>
            </div>

            <div class="feed-section">
                <div class="feed-title">Recent Donations (<span id="count"><%= donations.length %></span>)</div>
                <div id="donationFeed">
                    <% donations.forEach(function(d) { %>
                        <div class="donation-row">
                            <div class="donor-avatar">‚ù§</div>
                            <div class="donor-meta">
                                <strong><%= d.donorName %></strong>
                                <span>‚Ç¶<%= d.amount.toLocaleString() %></span>
                                <% if(d.comment) { %>
                                    <div class="donor-msg"><%= d.comment %></div>
                                <% } %>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </main>

        <aside class="sticky-column">
            <div class="donation-card">
                <div class="amount-large">‚Ç¶<span class="live-amt"><%= raised.toLocaleString() %></span></div>
                <div class="goal-text">raised of ‚Ç¶<%= goal.toLocaleString() %> goal</div>
                
                <div class="progress-container">
                    <div class="progress-bar live-bar" style="width: <%= (raised / goal) * 100 %>%"></div>
                </div>

                <div style="margin-bottom: 20px; font-weight: 600;">
                    <span id="countSidebar"><%= donations.length %></span> donations
                </div>

                <button onclick="openModal()" class="btn-donate">Donate now</button>
                <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #6b7280;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" height="14" style="margin-right:5px;">
                    Secured by Paystack
                </div>
            </div>
        </aside>

    </div>

    <div class="mobile-footer">
        <div class="mobile-footer-text">
            Raised: ‚Ç¶<span class="live-amt"><%= raised.toLocaleString() %></span>
        </div>
        <button onclick="openModal()" class="mobile-donate-btn">Donate Now</button>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <h2 style="font-weight: 800;">Make a Donation</h2>
                <span onclick="closeModal()" style="font-size: 24px; cursor: pointer;">&times;</span>
            </div>
            
            <input type="number" id="payAmount" class="input-field" placeholder="Amount (e.g., 5000)" required>
            <input type="email" id="payEmail" class="input-field" placeholder="Email Address" required>
            <input type="text" id="payName" class="input-field" placeholder="Full Name (Optional)">
            <textarea id="payComment" class="input-field" placeholder="Leave a prayer or comment..." rows="3"></textarea>
            
            <button onclick="pay()" class="btn-donate" style="background: var(--primary); color: white;">Proceed to Pay</button>
        </div>
    </div>

    <script>
        const publicKey = "<%= publicKey %>";
        const socket = io();

        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // LIVE UPDATES
        socket.on('new_donation', (data) => {
            // Update Amounts
            document.querySelectorAll('.live-amt').forEach(el => el.innerText = data.totalRaised.toLocaleString());
            
            // Update Bars
            const percent = (data.totalRaised / <%= goal %>) * 100;
            document.querySelectorAll('.live-bar').forEach(el => el.style.width = percent + "%");

            // Update Counts
            const newCount = parseInt(document.getElementById('count').innerText) + 1;
            document.getElementById('count').innerText = newCount;
            if(document.getElementById('countSidebar')) document.getElementById('countSidebar').innerText = newCount;

            // Add to Feed
            const feed = document.getElementById('donationFeed');
            const item = `
                <div class="donation-row" style="background-color: #f0fdf4; padding: 10px; border-radius: 8px;">
                    <div class="donor-avatar">‚ú®</div>
                    <div class="donor-meta">
                        <strong>${data.donorName}</strong>
                        <span>‚Ç¶${data.amount.toLocaleString()}</span>
                        ${data.comment ? `<div class="donor-msg">${data.comment}</div>` : ''}
                    </div>
                </div>`;
            feed.insertAdjacentHTML('afterbegin', item);
        });

        async function pay() {
            const amount = document.getElementById('payAmount').value;
            const email = document.getElementById('payEmail').value;
            const name = document.getElementById('payName').value;
            const comment = document.getElementById('payComment').value;

            if(!amount || !email) return alert("Please enter Amount and Email");

            const res = await fetch('/donate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ amount, email, name, comment })
            });
            const data = await res.json();

            const handler = PaystackPop.setup({
                key: publicKey,
                email: email,
                amount: amount * 100,
                ref: data.reference,
                callback: function() {
                    closeModal();
                    alert("JazakAllahu Khairan! Donation successful.");
                }
            });
            handler.openIframe();
        }
    </script>
</body>
</html>
