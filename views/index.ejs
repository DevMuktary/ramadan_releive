<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Relief Fund | Abu Hayyan School</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

    <nav>
        <div class="nav-container">
            <div class="logo">
                üåô Ramadan Relief <span>Verified</span>
            </div>
            <a href="#" style="color: var(--primary); font-weight: 600; text-decoration: none;">Abu Hayyan School</a>
        </div>
    </nav>

    <div class="container">
        
        <main>
            <h1 class="campaign-title">Ramadan Food Relief for 50 Vulnerable Families</h1>
            
            <div class="hero-img">
                <img src="https://images.unsplash.com/photo-1593113616825-d66722e28ee9?q=80&w=2070&auto=format&fit=crop" alt="Ramadan Food Distribution">
            </div>

            <div class="organizer-badge">
                <div class="badge-icon">AH</div>
                <div>
                    <div style="font-weight: 700; color: var(--text-dark);">Abu Hayyan School of Skills & Deen</div>
                    <div style="font-size: 0.9rem; color: var(--text-light);">Organizer <span class="verified-check">‚úì Verified Charity</span></div>
                </div>
            </div>

            <div class="story">
                <p><strong>As-salamu alaykum wa rahmatullahi wa barakatuh,</strong></p>
                <p>As the blessed month of Ramadan approaches, many families in our community are wondering where their Suhoor and Iftar will come from. While we prepare our pantries, our neighbors are struggling with the rising cost of food.</p>
                <p>Our goal is to raise <strong>‚Ç¶1,000,000</strong> to provide essential food packs (Rice, Beans, Garri, Oil, and Dates) to 50 vulnerable households before the moon is sighted.</p>
                <p>The Prophet (Ô∑∫) said: <em>"Whoever provides food for a fasting person to break his fast with, then for him is the same reward as his..."</em> (Tirmidhi).</p>
            </div>

            <div class="updates-header">Recent Donations</div>
            <div id="donationFeed">
                <% donations.forEach(function(d) { %>
                    <div class="donation-item">
                        <div class="donor-icon">‚ù§</div>
                        <div class="donor-details">
                            <strong><%= d.donorName %></strong>
                            <span>Donated ‚Ç¶<%= d.amount.toLocaleString() %></span>
                            <% if(d.comment) { %>
                                <div class="donor-comment"><%= d.comment %></div>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            </div>
        </main>

        <aside class="sticky-wrapper">
            <div class="card">
                <div class="amount-display">‚Ç¶<span id="amountTxt"><%= raised.toLocaleString() %></span></div>
                <div class="goal-display">raised of ‚Ç¶<%= goal.toLocaleString() %> goal</div>

                <div class="progress-track">
                    <div id="progressBar" class="progress-fill" style="width: <%= (raised / goal) * 100 %>%"></div>
                </div>

                <div style="margin-bottom: 20px;">
                    <strong><span id="countTxt"><%= donations.length %></span></strong> people have donated
                </div>

                <button onclick="openModal()" class="btn-donate">Donate now</button>
                
                <div class="guarantee">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    Secure donation via Paystack
                </div>
            </div>
            
            <button onclick="simulateTest()" style="margin-top:20px; font-size:0.8rem; color:#aaa; background:none; border:none; cursor:pointer;">[Dev: Test Animation]</button>
        </aside>

    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 1.5rem; font-weight: 800;">Make a Donation</h2>
            
            <input type="number" id="payAmount" class="input-field" placeholder="Amount (‚Ç¶)" required>
            <input type="email" id="payEmail" class="input-field" placeholder="Email Address" required>
            <input type="text" id="payName" class="input-field" placeholder="Your Name (Optional)">
            <textarea id="payComment" class="input-field" placeholder="Leave a prayer..." rows="3"></textarea>
            
            <button onclick="processPayment()" class="btn-donate" style="background: var(--primary); color: white;">Continue to Paystack</button>
        </div>
    </div>

    <script>
        const publicKey = "<%= publicKey %>";
        const socket = io();

        // 1. ANIMATE PROGRESS BAR ON LOAD
        window.onload = () => {
            const percent = (<%= raised %> / <%= goal %>) * 100;
            setTimeout(() => { document.getElementById('progressBar').style.width = percent + "%"; }, 500);
        };

        // 2. LIVE UPDATES LISTENER
        socket.on('new_donation', (data) => {
            // Update Numbers
            document.getElementById('amountTxt').innerText = data.totalRaised.toLocaleString();
            
            // Update Bar
            const percent = (data.totalRaised / <%= goal %>) * 100;
            document.getElementById('progressBar').style.width = percent + "%";

            // Add to List
            const list = document.getElementById('donationFeed');
            const item = `
                <div class="donation-item" style="background-color: #ecfdf5; padding: 10px; border-radius: 8px;">
                    <div class="donor-icon" style="background:white;">‚ú®</div>
                    <div class="donor-details">
                        <strong>${data.donorName}</strong>
                        <span>Just donated ‚Ç¶${data.amount.toLocaleString()}</span>
                        ${data.comment ? `<div class="donor-comment">${data.comment}</div>` : ''}
                    </div>
                </div>`;
            list.insertAdjacentHTML('afterbegin', item);
        });

        // 3. PAYMENT FUNCTIONS
        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        async function processPayment() {
            const amount = document.getElementById('payAmount').value;
            const email = document.getElementById('payEmail').value;
            const name = document.getElementById('payName').value;
            const comment = document.getElementById('payComment').value;

            if(!amount || !email) return alert("Please enter amount and email");

            // Create Transaction on Server
            const res = await fetch('/donate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount, email, name, comment })
            });
            const data = await res.json();

            // Open Paystack
            const handler = PaystackPop.setup({
                key: publicKey,
                email: email,
                amount: amount * 100, 
                ref: data.reference,
                callback: function(response) {
                    closeModal();
                    alert("May Allah accept your sadaqah! The bar will update shortly.");
                }
            });
            handler.openIframe();
        }

        // 4. SIMULATION TOOL (For Testing)
        function simulateTest() {
            // This manually triggers the socket event locally to test UI
            // It does NOT save to database
            const fakeData = {
                donorName: "Test Donor",
                amount: 5000,
                comment: "Testing the live update feature!",
                totalRaised: parseInt(document.getElementById('amountTxt').innerText.replace(/,/g,'')) + 5000
            };
            // Manually trigger the listener
            socket._callbacks['$new_donation'][0](fakeData);
        }
    </script>
</body>
</html>
